<!doctype html>
<html class="no-js">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />
<link rel="index" title="Index" href="genindex.html" /><link rel="search" title="Search" href="search.html" /><link rel="next" title="API" href="api.html" /><link rel="prev" title="LMDB Usage Example" href="06_lmdb_example.html" />

    <meta name="generator" content="sphinx-4.5.0, furo 2022.06.04.1"/>
        <title>Squirrel thoughts - BigEarthNet Encoder documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo.css?digest=40978830699223671f4072448e654b5958f38b89" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/asciinema-player.css" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo-extensions.css?digest=30d1aed668e5c3a91c3e3bf6a60b675221979f0e" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="intro.html"><div class="brand">BigEarthNet Encoder  documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="intro.html">
  
  
  <span class="sidebar-brand-text">BigEarthNet Encoder  documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="search.html" role="search">
  <input class="sidebar-search" placeholder=Search name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="00_general.html">General</a></li>
<li class="toctree-l1"><a class="reference internal" href="02_conversion_process.html">Conversion process</a></li>
<li class="toctree-l1"><a class="reference internal" href="05_lmdb.html">LMDB</a></li>
<li class="toctree-l1"><a class="reference internal" href="06_lmdb_example.html">LMDB Usage Example</a></li>
<li class="toctree-l1 current current-page"><a class="current reference internal" href="#">Squirrel thoughts</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="api.html">API</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="api_encoder.html">API Encoder</a></li>
</ul>
</li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <section class="tex2jax_ignore mathjax_ignore" id="squirrel-thoughts">
<h1>Squirrel thoughts<a class="headerlink" href="#squirrel-thoughts" title="Permalink to this headline">#</a></h1>
<blockquote>
<div><p>A couple of thoughts about the squirrel library</p>
</div></blockquote>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This is an initial draft discussing the pros/cons of the <a class="reference external" href="https://squirrel-datasets-core.readthedocs.io/en/latest/">Squirrel</a> library for BigEarthNet!</p>
<p>Please skip this section if you are not actively working on the Encoder library!</p>
</div>
<p>In general, the core idea of the Squirrel library is that it is an iterator-based dataset wrapper.
As a result, the encoded dataset is designed to be consumed entirely.
If only small random subsets are loaded, I expect the Squirrel data to perform poorly.</p>
<p>The key strategy to maximize the read-performance is to read <em>large</em> files.
SSDs have a low random-read performance (~200–900 MB/s).
Frequently reading small chunks of data (i.e., images/patches) is nothing else than randomly reading from disk.
The data must be converted into a different format that is better suited to allow quick data access.</p>
<p>To maximize the read-performance, the data must be orders of magnitudes greater than 4KB (the smallest unit of data accessed by the SSD).
A possible solution is <em>sharding</em>.
<em>Sharding</em> aggregates multiple <em>smaller</em>_ files into <em>larger</em> storage units (<em>shards</em>).
A simple way to generate shards is to convert the data into the GNU <code class="docutils literal notranslate"><span class="pre">tar</span></code> format.
Combining the sharding strategy with compression can reduce the data size, benefiting data accessed over the network.
The recommended size of each shard is between 128MB – 1GB.
For more details, refer to the <a class="reference external" href="https://arxiv.org/abs/2001.01858">High Performance I/O for large scale deep learning paper from NVIDIA</a>.</p>
<p>Important questions that need to be answered:</p>
<ul class="simple">
<li><p>Can sharding be applied in such a way that it could be split by country?</p>
<ul>
<li><p>Possibly with suffixes to hit the size sweet-spot</p></li>
<li><p>How hard is the performance impact, if I access a random subset?</p>
<ul>
<li><p>This is not <em>too</em> important because we could regenerate the dataset depending on the application</p></li>
</ul>
</li>
<li><p>What is the impact on the randomness of the data?</p>
<ul>
<li><p>How to tune the parameters to create <em>truly random</em> batches?</p></li>
<li><p>We train with batch sizes from 128 – 2048</p></li>
</ul>
</li>
</ul>
</li>
<li><p>Is there a way to cache the entire dataset in memory?</p></li>
<li><p>How to efficiently split train/validation/test set?</p>
<ul>
<li><p>Their example code uses datasets that already provide train/validation/test splits as shards.</p></li>
<li><p><a class="reference external" href="https://squirrel-datasets-core.readthedocs.io/en/latest/dataset_links/cc100.html">CC100</a> from the Squirrel-Datasets documentation does not give a train/test/validation split</p>
<ul>
<li><p>Sharded by language</p></li>
</ul>
</li>
<li><p>It looks like the best approach would be to re-generate the dataset according to the used split to optimize the performance</p></li>
</ul>
</li>
</ul>
<section id="shard-size">
<h2>Shard size<a class="headerlink" href="#shard-size" title="Permalink to this headline">#</a></h2>
<p>Converting the patches to the intermediate <a class="reference external" href="https://docs.kai-tub.tech/bigearthnet_patch_interface/">BigEarthNet Patch Interface</a> format, the resulting object size is ~16KB.
To create shards with a size of 1GB, we could combine ~6650 patches (without compression).
If we train with the usual batch sizes of around 1024 patches per batch, how strongly would the shard-size impact the randomness?</p>
<p>How much time does the decompression take?
Would it make sense to compress the data in a different format to GZIP, like LZ4 or ZSTD, which may decode faster than GZIP?</p>
</section>
<section id="performance-discussion">
<h2>Performance discussion<a class="headerlink" href="#performance-discussion" title="Permalink to this headline">#</a></h2>
<p>I am currently using <code class="docutils literal notranslate"><span class="pre">cProfile</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python -m cProfile -o stats.dump reader.py
snakeviz stats.dump
</pre></div>
</div>
<p>To analyze where most time is spent.</p>
<p>In my first mini-tests, the Squirrel dataset is significantly slower than the LMDB variant.
The main issue is that most time is spent decompressing the archive.
Without the decompression, the performance would be roughly similar.</p>
<p>These results are done without applying any shuffling at all!</p>
<p>With GZIP compression:</p>
<ul class="simple">
<li><p>2 * 6600 patches = 2 * 797MB</p></li>
<li><p>Iteration over both shards takes ~14sek</p>
<ul>
<li><p>Most of the time is required to unpack the archive</p></li>
<li><p>It would take ~10min to pass through the dataset</p></li>
<li><p>Could it potentially be minimized by prefetching?</p></li>
</ul>
</li>
</ul>
<p>LMDB:</p>
<ul class="simple">
<li><p>2 * 6600 patches = 2.2GB</p></li>
<li><p>Iteration of the entire LMDB file takes ~4sek</p>
<ul>
<li><p>To iterate over BigEarthNet, it would take ~3min</p></li>
</ul>
</li>
</ul>
</section>
<section id="data-access-in-detail">
<h2>Data access in detail<a class="headerlink" href="#data-access-in-detail" title="Permalink to this headline">#</a></h2>
<ul class="simple">
<li><p>With <code class="docutils literal notranslate"><span class="pre">keys_iterable</span></code> only specific shards can be accessed.</p></li>
<li><p>The keys themselves can be easily shuffled.</p></li>
<li><p>So the shard access can be easily randomized.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">shuffle_item_buffer</span></code> is size of the buffer used to shuffle items after items are fetched.</p></li>
<li><p>Are multiple shards unpacked?</p></li>
</ul>
</section>
<section id="data-shuffling-in-detail">
<h2>Data shuffling in detail<a class="headerlink" href="#data-shuffling-in-detail" title="Permalink to this headline">#</a></h2>
<figure class="align-default" id="id1">
<img alt="_images/squirrel_shuffle.svg" src="_images/squirrel_shuffle.svg" /><figcaption>
<p><span class="caption-text">Data shuffling in squirrel</span><a class="headerlink" href="#id1" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="api.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">API</div>
              </div>
              <svg><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="06_lmdb_example.html">
              <svg><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">LMDB Usage Example</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2022, Kai Norman Clasen
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            <div class="icons">
              <a class="muted-link " href="https://github.com/kai-tub/bigearthnet_encoder/" aria-label="GitHub">
                <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"></path>
                </svg>
            </a>
              
            </div>
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            Contents
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Squirrel thoughts</a><ul>
<li><a class="reference internal" href="#shard-size">Shard size</a></li>
<li><a class="reference internal" href="#performance-discussion">Performance discussion</a></li>
<li><a class="reference internal" href="#data-access-in-detail">Data access in detail</a></li>
<li><a class="reference internal" href="#data-shuffling-in-detail">Data shuffling in detail</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/scripts/furo.js"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({startOnLoad:true});</script>
    </body>
</html>